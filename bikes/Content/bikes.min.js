"use strict";angular.module("bikesApp",["ui.router","ui.grid","bikeServices"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/user-home"),a.state("home",{url:"/home",templateUrl:"/content/app/html/home.html",controller:"homeController"}).state("userHome",{url:"/user-home",templateUrl:"/content/app/html/user-home.html",controller:"userHomeController"}).state("analysis",{url:"/analysis",templateUrl:"/content/app/html/analysis.html",controller:"analysisController"}).state("fiddle",{url:"/fiddle",templateUrl:"/content/app/html/fiddle.html",controller:"fiddleController"}).state("paymentList",{url:"/payment",templateUrl:"/content/app/html/payment-list.html",controller:"paymentListController"}).state("rideList",{url:"/ride",templateUrl:"/content/app/html/ride-list.html",controller:"rideListController"}).state("rideAdd",{url:"/ride/add/:riderId",templateUrl:"/content/app/html/ride-add.html",controller:"rideAddController"}).state("rideEdit",{url:"/ride/:id/edit",templateUrl:"/content/app/html/ride-edit.html",controller:"rideEditController"}).state("routeList",{url:"/route",templateUrl:"/content/app/html/route-list.html",controller:"routeListController"}).state("routeAdd",{url:"/route/:id/add",templateUrl:"/content/app/html/route-edit.html",controller:"routeEditController"}).state("routeEdit",{url:"/route/:id/edit",templateUrl:"/content/app/html/route-edit.html",controller:"routeEditController"}).state("riderList",{url:"/rider",templateUrl:"/content/app/html/rider-list.html",controller:"riderListController"}).state("riderAdd",{url:"/rider/:id/add",templateUrl:"/content/app/html/rider-edit.html",controller:"riderEditController"}).state("riderEdit",{url:"/rider/:id/edit",templateUrl:"/content/app/html/rider-edit.html",controller:"riderEditController"}).state("riderPwd",{url:"/rider/:id/pwd",templateUrl:"/content/app/html/rider-pwd.html",controller:"riderPwdController"}).state("bikeList",{url:"/bike",templateUrl:"/content/app/html/bike-list.html",controller:"bikeListController"}).state("bikeAdd",{url:"/bike/:id/add",templateUrl:"/content/app/html/bike-edit.html",controller:"bikeEditController"}).state("bikeEdit",{url:"/bike/:id/edit",templateUrl:"/content/app/html/bike-edit.html",controller:"bikeEditController"})}]),angular.module("bikeServices",["ngResource"]).factory("Bike",["$resource",function(a){return a("/api/bike/:id",{id:"@id"})}]).factory("Rider",["$resource",function(a){return a("/api/rider/:id",{id:"@id"})}]).factory("RiderPwd",["$resource",function(a){return a("/api/rider/:id/pwd",{id:"@id"},{setPwd:{method:"POST"}})}]).factory("Route",["$resource",function(a){return a("/api/route/:id",{id:"@id"})}]).factory("Ride",["$resource",function(a){return a("/api/ride/:id",{id:"@id"},{trash:{method:"POST",url:"/api/ride/:id/delete"}})}]).factory("RiderSummary",["$resource",function(a){return a("/api/rider/:riderId/RiderSummary/:month",{riderId:"@riderId",month:"@month"})}]).factory("Payment",["$resource",function(a){return a("/api/payment")}]).factory("BankBranch",["$resource",function(a){return a("/api/bank/branch")}]).factory("BankCustomer",["$resource",function(a){return a("/api/bank/branch/:branchId/customer",{branchId:"branchId"})}]).factory("BankAccount",["$resource",function(a){return a("/api/bank/customer/:customerId/account",{customerId:"customerId"})}]).factory("Model",["$resource",function(a){return a("/api/model/:year",{year:"@year"})}]).factory("model",["Model",function(a){var b=function(){return a.get({year:2016},function(a){a.rides.forEach(function(a){a.ride_date=new Date(a.ride_date)}),a.yearSummaryChartData={labels:(new jinqJs).from(a.months).select(function(a){return a.caption}),datasets:(new jinqJs).from(a.riders).select(function(b){return{riderId:b.id,label:b.name,fillColor:b.color_code,data:(new jinqJs).from(a.months).select(function(c){return(new jinqJs).from(a.rides).where(function(a){return a.rider_id==b.id&&a.month==c.month}).sum("distance").select()[0]})}})},a.monthSummaryChartData={labels:[moment().format("MMMM")],datasets:(new jinqJs).from(a.riders).select(function(b){return{riderId:b.id,label:b.name,fillColor:b.color_code,data:(new jinqJs).from(a.rides).where(function(a){return a.rider_id==b.id&&a.month==moment().month()+1}).sum("distance").select()}})}})};return{data:b(),refresh:function(){this.data=b()}}}]),angular.module("bikesApp").controller("bikeListController",["$scope","$state","model",function(a,b,c){a.data=c.data,a.add=function(){b.go("bikeAdd",{id:0})}}]).controller("bikeEditController",["$scope","$state","$stateParams","model","Bike",function(a,b,c,d,e){0==c.id?a.bike=new e:a.bike=e.get({id:c.id}),a.saveForm=function(){a.bike.$save(function(){d.refresh(),b.go("bikeList")})},a.deleteBike=function(){a.bike.$delete(function(){d.refresh(),b.go("bikeList")})},a.cancel=function(){b.go("bikeList")}}]),angular.module("bikesApp").controller("riderListController",["$scope","$state","model",function(a,b,c){a.data=c.data,a.add=function(){b.go("riderAdd",{id:0})}}]).controller("riderPwdController",["$scope","$state","$stateParams","RiderPwd",function(a,b,c,d){a.rider=new d,a.saveForm=function(){a.rider.$setPwd({id:c.id},function(){b.go("riderList")},function(){alert("Could not save rider")})},a.cancel=function(){b.go("riderList")}}]).controller("riderEditController",["$scope","$state","$stateParams","model","Rider","BankBranch","BankCustomer","BankAccount",function(a,b,c,d,e,f,g,h){a.branches=f.query(),a.customers=[],a.accounts=[],a.data=d.data,0==c.id?a.rider=new e:a.rider=e.get({id:c.id}),a.$watch("rider.bank_branch_id",function(){a.customers=g.query({branchId:a.rider.bank_branch_id})}),a.$watch("rider.bank_customer_id",function(){a.accounts=h.query({customerId:a.rider.bank_customer_id})}),a.saveForm=function(){a.rider.$save(function(){d.refresh(),b.go("riderList")},function(){alert("Could not save rider")})},a.deleteRider=function(){a.rider.$delete(function(){d.refresh(),b.go("riderList")})},a.setPwd=function(){b.go("riderPwd",{id:c.id})},a.cancel=function(){b.go("riderList")}}]),angular.module("bikesApp").controller("routeListController",["$scope","$state","model",function(a,b,c){a.data=c.data,a.add=function(){b.go("routeAdd",{id:0})}}]).controller("routeEditController",["$scope","$state","$stateParams","model","Route",function(a,b,c,d,e){0==c.id?a.route=new e:a.route=e.get({id:c.id}),a.saveForm=function(){a.route.$save(function(){d.refresh(),b.go("routeList")})},a.deleteRoute=function(){a.route.$delete(function(){d.refresh(),b.go("routeList")})},a.cancel=function(){b.go("routeList")}}]),angular.module("bikesApp").controller("rideListController",["$scope","$state","model",function(a,b,c){a.data=c.data,a.add=function(){b.go("rideAdd")}}]).controller("rideAddController",["$scope","$state","$stateParams","model","Ride","Rider","Route","Bike",function(a,b,c,d,e,f,g,h){a.routeCaption=function(a){return 1==a.id?a.name:a.name+" ("+a.distance+" miles)"};var i=function(){c.riderId?b.go("userHome"):b.go("rideList")},j=function(b){var c;for(c=0;c<a.riders.length;c++)if(a.riders[c].id===b)return a.riders[c]},k=function(b){var c;for(c=0;c<a.routes.length;c++)if(a.routes[c].id===b)return a.routes[c]};a.routes=g.query(),a.bikes=h.query(),a.riders=f.query(),a.ride=new e,a.ride.distance=0,a.ride.payable=!1,a.ride.bonus=0,a.ride.rider_id=c.riderId?parseInt(c.riderId,10):0,a.ride.route_id=1,a.ride.bike_id=1,a.calculateReward=function(){var b,c;if(a.ride.payable){var d=j(a.ride.rider_id);if(d){if(a.ride.routeId>1){var e=k(a.ride.route_id);b=e.distance,a.ride.returnRide&&(b=2*b)}else b=a.ride.distance;c=a.ride.bonus+b*d.rate/100}else c=a.ride.bonus}else c=0;return c.toFixed(2)},a.saveForm=function(){a.ride.ride_date=new Date(""+a.ride.ride_date.substr(6,4)+"-"+a.ride.ride_date.substr(3,2)+"-"+a.ride.ride_date.substr(0,2)+"-T12:00:00"),a.ride.$save(function(){d.refresh(),i()},function(){alert("Failed to save new ride."),i()})},a.cancel=function(){i()}}]).controller("rideEditController",["$scope","$state","$stateParams","model","Ride",function(a,b,c,d,e){a.ride=e.get({id:c.id});var f=function(){c.riderId?b.go("userHome"):b.go("rideList")};a.saveForm=function(){a.ride.$save(function(){d.refresh(),f()})},a.deleteRide=function(){e.trash({id:c.id},function(b){"OK"==b.status?(d.refresh(),f()):"ALREADY_PAID"==b.status?a.message="Rides that have been paid cannot be deleted.":a.message="There was a problem deleting this ride."},function(a){alert("failed to delete ride - "+a.status)})},a.cancel=function(){f()}}]),angular.module("bikesApp").controller("homeController",["$scope","$state","model",function(a,b,c){a.data=c.data,a.$watch("data.months",function(){if(c.data.months){var a=document.getElementById("barYearSummary").getContext("2d");new Chart(a).Bar(c.data.yearSummaryChartData,{responsive:!0,maintainAspectRatio:!1,multiTooltipTemplate:"<%=datasetLabel%> <%=value%>"});var b=document.getElementById("barMonthSummary").getContext("2d");new Chart(b).Bar(c.data.monthSummaryChartData,{responsive:!0,maintainAspectRatio:!1,multiTooltipTemplate:"<%=datasetLabel%> <%=value%>"})}})}]),angular.module("bikesApp").controller("paymentListController",["$scope","$state","model","Payment",function(a,b,c,d){a.data=c.data,a.pay=function(){d.save(),c.refresh(),b.go("home")}}]),angular.module("bikesApp").controller("analysisController",["$scope","$state","uiGridConstants","model",function(a,b,c,d){a.data=d.data,a.gridOptions={enableSorting:!0,enableFiltering:!0,showGridFooter:!0,showColumnFooter:!0,columnDefs:[{name:"rider",field:"rider"},{name:"bike",field:"bike"},{name:"route",field:"route"},{name:"distance",field:"distance",type:"number",aggregationType:c.aggregationTypes.sum,footerCellTemplate:"<div>{{col.getAggregationValue() | number : 0}}</div>",enableFiltering:!1},{name:"reward",field:"reward",type:"number",aggregationType:c.aggregationTypes.sum,footerCellTemplate:"<div>{{col.getAggregationValue() | number : 2}}</div>",enableFiltering:!1},{name:"date",field:"ride_date",type:"date",cellFilter:"date",enableFiltering:!1}],data:"data.rides"}}]),angular.module("bikesApp").controller("userHomeController",["$scope","$state","currentUser","model",function(a,b,c,d){a.data=d.data,a.currentUser=c,a.$watch("data.months",function(){if(a.rider=(new jinqJs).from(d.data.riders).where(function(a){return a.id==c.riderId}).select()[0],d.data.months){var b=JSON.parse(JSON.stringify(d.data.yearSummaryChartData));b.datasets=(new jinqJs).from(b.datasets).where(function(b){return b.riderId==a.rider.id}).select();var e=document.getElementById("barYearSummary").getContext("2d");new Chart(e).Bar(b,{responsive:!0,maintainAspectRatio:!1,multiTooltipTemplate:"<%=datasetLabel%> <%=value%>"}),a.currentUserRides=(new jinqJs).from(d.data.rides).where(function(a){return a.rider_id==c.riderId}).select()}a.summary=(new jinqJs).from(d.data.riderSummary).where(function(b){return b.riderId==a.rider.id}).select()[0]}),a.addRide=function(){b.go("rideAdd",{riderId:c.riderId})}}]),angular.module("bikesApp").controller("fiddleController",["$scope","$state","$stateParams",function(a,b,c){}]);